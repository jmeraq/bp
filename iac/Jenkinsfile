pipeline {
    agent {
        docker {
            image 'jmeraq/tools:latest'
             args '-u root:root'
        }
    }

    environment {
        CI = 'true'
        IMAGE_OWNER          = "jmeraq"
        REPOSITORY_BASE_NAME = """${sh(
                returnStdout: true,
                script: 'git config --get remote.origin.url | cut -d "/" -f 5 | cut -d "." -f 1 | tr -d \'[[:space:]]\'').trim()}"""
    }


    stages {
        stage('Init'){
            stages{
                stage('Init: Confirm Deploy to Producction') {
                    when {
                        anyOf { branch 'master' }
                    }
                    steps {
                        timeout(time: 5, unit: 'MINUTES') {
                            input "Really want to deploy to production?"
                        }
                    }
                }
                stage('Init: Define Version and Variables') {
                    steps {
                        timeout(time: 5, unit: 'MINUTES') {
                            script {
                                VERSION     = new Date().format( 'yyyy.MM.dd.H.m.s' )
                                ACTION      = input id: 'Environment-deployment',
                                        message: 'Que deseas realizar?',
                                        ok: 'OK',
                                        parameters: [[$class: 'ChoiceParameterDefinition', choices: ['apply', 'destroy'], description: 'Selecionar accion que desea realizar', name: 'Environment']]
                                if (env.BRANCH_NAME == 'master') {
                                    ENVIRONMENT = "production"
                                    VERSION     = "${ENVIRONMENT}-${VERSION}"
                                } else {
                                    ENVIRONMENT = "demo"
                                    VERSION     = "${ENVIRONMENT}-${VERSION}"
                                }
                            }
                        }
                    }
                }
            }
        }
        stage('Build: Execute Action') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_credential', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                    sh "cd iac/ && terraform init"
                    sh "cd iac/ && terraform plan"
                    sh "cd iac/ && terraform ${ACTION} -auto-approve"
                }
            }
        }

        stage ('Build: Publish Tag Git') {
            steps {
                sh "ls -la && whoami"
                sh "mkdir /home/jenkins/github/"
                sh "cp -r ./ /home/jenkins/github/"
                sh "cd /home/jenkins/github/ && ls -la"
                sh "cd /home/jenkins/github/ && git remote -v"
                sh "cd /home/jenkins/github/ && git config --global user.email 'jenkins@detic.ec'"
                sh "cd /home/jenkins/github/ && git config --global user.name 'Jenkins'"
                sh "cd /home/jenkins/github/ && git tag -a '${VERSION}' -m '${VERSION}'"
                sh "cd /home/jenkins/github/ && git add . && git commit -m 'test jenkins' && git push"
                sh "cd /home/jenkins/github/ && git commit -m 'test jenkins'"
                sh "cd /home/jenkins/github/ && git push"
                /*withCredentials(bindings: [sshUserPrivateKey(credentialsId: 'github_private_key', keyFileVariable: 'github_jenkins_key', usernameVariable: '')]) {
                    sh """
                        mkdir /root/.ssh
                        touch /root/.ssh/known_hosts
                        touch /root/.ssh/id_rsa
                        ssh-keyscan github.com >> /root/.ssh/known_hosts
                        cat $github_jenkins_key >> /root/.ssh/id_rsa
                        chmod 400 /root/.ssh/id_rsa
                        ls -la
                        git status
                        git remote -v
                        git config --global user.email 'jenkins@detic.ec'
                        git config --global user.name 'Jenkins'
                        git tag -a '${VERSION}' -m '${VERSION}'
                        git add . && git commit -m 'test jenkins' && git push
                    """
                }*/
            }
        }
    }
}